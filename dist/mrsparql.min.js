!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).MrSparql=t()}(this,(function(){"use strict";class e{constructor(){this.lookup=new Map,this._allPrefixes=[]}loadPrefix(e){this.lookup.set(e.short,e),this.lookup.set(e.long,e),this._allPrefixes.push(e.short,e.long)}loadPrefixStrings(e){e.map(e=>{const s=new t(e);this.loadPrefix(s)})}getPrefix(...e){let t=[];for(let s=0;s<this._allPrefixes.length||t.length===e.length;s++){const r=this._allPrefixes[s];e=e.filter((e,s)=>!e.startsWith(r)||(t.push(this.lookup.get(r)),!1))}return 1===t.length?t[0]:t}qualify(e){const t=this.getPrefix(e);return e.startsWith(t.short)?t.long+e.substring(t.short.length+1):e}isPrefixMatch(e,t){const s=this.getPrefix(e,t);return s[0]===s[1]}isUriMatch(e,t){return e===t||this.qualify(e)===this.qualify(t)}}class t{constructor(e){this.prefixString=e,this._prefixRegex=/([^:\s]+)\s*:\s*(.+)/,this.representations=[],this.parsePrefixString()}parsePrefixString(){const e=this.prefixString.trim().match(this._prefixRegex);this.short=e[1],this.long=e[2].replace(/[<>]/g,""),this.representations.push(e[1],e[2])}toString(){return this.prefixString}}class s{constructor(e){this.updateSettings(e),this.edgeMap=new Map,this.edgeIdCounter=new Map}updateSettings(e){this.settings=Object.assign({bundlingStrategy:{type:"bidirectional",count:!0}},e)}_reverseId(e){return e.split("-").reverse().join("-")}get strategyType(){return this.settings.bundlingStrategy.type}getEdge(e){return"unidirectional"===this.strategyType?this.edgeMap.get(e)||this.edgeMap.get(this._reverseId(e)):this.edgeMap.get(e)}nextId(e){if("unidirectional"===this.strategyType){const t=this._reverseId(e),s=this.edgeIdCounter.has(e)?e:this.edgeIdCounter.has(t)?t:e,r=this.edgeIdCounter.get(s)||0;return this.edgeIdCounter.set(s,r+1),s}if("bidirectional"===this.strategyType){const t=this.edgeIdCounter.get(e)||0;return this.edgeIdCounter.set(e,t+1),e}{const t=(this.edgeIdCounter.get(e)||0)+1;return this.edgeIdCounter.set(e,t),[e,t].join("-")}}addEdge(e){const t=this.nextId(e.id);e.id=t,this.settings.bundlingStrategy.count&&(e._count=this.edgeIdCounter.get(t)||1),this.edgeMap.set(t,e)}getEdges(){return Array.from(this.edgeMap.values())}}function r(e){const t=[32,9,13,10];for(let s=0;s<t.length;s++)if(e.charCodeAt(0)===t[s])return!0;return!1}function i(e){return/\w/.test(e)}function o(e){return";"===e||"."===e||"}"===e}class n extends Error{constructor(...e){super(...e),Error.captureStackTrace&&Error.captureStackTrace(this,CustomError),this.name="SparqlParseError"}}function a(e){let s,a,h,u=0,p=[];const g=[],l=[],f=[];let d=[];const b=[];let v=0;function y(e){3===d.length&&f.push(d);const t=[];";"===e&&t.push(d[0]),d=t}function x(){if("}"===h)p.pop(),a="",y(h);else if(r(h)){const e=a.charAt(a.length-1);a.length>0&&(o(e)?(a=a.substring(0,a.length-1),a&&d.push(a),a="",y(e)):["union","optional","values"].some(e=>a.toLowerCase()===e)?(p.push(a.toLowerCase()),a=""):(d.push(a),a=""))}else o(a)?(y(a),a=""):"{"!==h&&(a+=h)}const w={comment(){"\n"===c&&p.pop()},token(){if(i(h))a+=h;else{if(!r(h))throw new n(`Invalid token found: ${h} in ${a}`);p.push(a.toLowerCase()),a=""}},prefix(){a+=h,">"===h&&(p.pop(),l.push(new t(a)),a="")},select(){"where"===a.toLowerCase()?(p.pop(),p.push("where"),a=""):r(h)?(a.startsWith("?")&&g.push(a.replace(",","")),a=""):a+=h},where:x,union:x,values(){r(h)?(b.push([a]),a=""):"{"===h?(a.length>1&&(b.push([a]),a=""),p.push("valuesvalues")):")"!==h&&"("!==h&&(a+=h)},valuesvalues(){"}"===h&&(a.length>1&&b[0].push(a),p.pop(),p.pop(),a=""),r(h)?(a.length>0&&("undef"!==a.toLowerCase()&&b[v].push(a),b.length>1&&v++),a=""):"("===h?v=0:")"===h?(a.length>0&&("undef"!==a.toLowerCase()&&b[v].push(a),a=""),v=0):a+=h},optional:x};for(;u!==e.length;)h=e.charAt(u),s=p[p.length-1],s?w[s]&&w[s]():"#"===h?p.push("comment"):i(h)&&(a=h,p.push("token")),u++;return{prefixes:l,triples:f,values:b}}const h={edgeSettings:{bundlingStrategy:{type:"bidirectional",count:!0}}};class u{static sparql(){return a.apply(null,arguments)}constructor(e,t){this.updateConfig(e,t)}updateConfig(t){this.rawConfig=Object.assign({},t),this.config=Object.assign({},h,t),this.prefixRegister=new e,Array.isArray(this.config.prefixes)&&this.prefixRegister.loadPrefixStrings(this.config.prefixes)}transform(e){return this.nodesMap=new Map,this.edgeManager=new s,this.processRows(e),{nodes:Array.from(this.nodesMap.values()),edges:this.edgeManager.getEdges()}}}class p extends u{constructor(e,t){super(e,t),this.updateConfig(e,t)}updateConfig(e,t){super.updateConfig(e),this.rawQuery=t,this.parsedQuery=a(t),this.parsedQuery.prefixes.forEach(e=>{this.prefixRegister.loadPrefix(e)})}processRows(e){Array.isArray(e)?e.forEach(e=>{this.getItems(e)}):e.results.bindings.forEach(e=>{this.getItems(e)})}getProcessedTriples(e){const t=[],s=["subject","predicate","object"];return this.parsedQuery.triples.forEach(r=>{const i={};r.forEach((t,r)=>{const o=s[r];let n,a;const h="?"===t.charAt(0);if(h){n=t.substring(1);const s=e[t.substring(1)];a="object"==typeof s?s.value:null}else n=t,a=t;i[o]={value:a,variable:n,part:t,isVariable:h}}),s.every(t=>e.hasOwnProperty(i[t].variable)&&e[i[t].variable].hasOwnProperty("value")||!i[t].isVariable)&&t.push(i)}),t}findRelationship(e){return this.config.edges.find(t=>t.matches.some(t=>this.config.nodes.hasOwnProperty(e.subject.variable)&&this.config.nodes.hasOwnProperty(e.object.variable)&&this.prefixRegister.isUriMatch(e.predicate.value,t)))}getItems(e){this.getProcessedTriples(e).forEach(e=>{const t=this.findRelationship(e);if(t){["subject","object"].forEach(t=>{const{variable:s,value:r}=e[t],i=this.config.nodes[s];if(i&&!this.nodesMap.has(r)){const e=this.config.groups[i.group].properties||{},t=Object.assign({},e,{id:r,group:i.group});this.nodesMap.set(r,t)}});const s=[e.subject.value,e.object.value].join("-"),r=t.properties||{},i=Object.assign({},r,{id:s,from:e.subject.value,to:e.object.value});this.edgeManager.addEdge(i)}else{const t=e.subject.value,s=this.nodesMap.get(t)||{id:t,properties:{}},r=this.config.nodes[e.subject.variable];let i=!1;for(let t in r){const o=r[t];if("object"==typeof o&&o.matches){if(this.prefixRegister.isUriMatch(e[o.matches.key].value,o.matches.value)){s[t]=e.object.value,i=!0;break}}}i||(s.properties||(s.properties={}),s.properties[e.predicate.value]=e.object.value),this.nodesMap.set(t,s)}})}}class g extends u{static sparql(){return a.apply(null,arguments)}constructor(e){super(e),this.updateConfig(e)}processRows(e){Array.isArray(e)?e.forEach(e=>{this.getNodes(e),this.getEdges(e)}):e.results.bindings.forEach(e=>{this.getNodes(e),this.getEdges(e)})}passesCondition(e,t){const{condition:s}=e;if(s)if(s.prefix){const r=t[e.variable],i=this.prefixRegister.lookup.get(s.prefix);if(!i)throw new Error(`Prefix for condition is not defined in config prefixes: ${s.prefix}`);if(this.prefixRegister.getPrefix(r.value)!==i)return!1}else if(s.equals){const e=t[s.variable].value,r=s.equals;if(!this.prefixRegister.isUriMatch(e,r))return!1}return!0}getProperties(e,t){const s={};return Array.isArray(e.properties)&&e.properties.forEach(e=>{if(this.passesCondition(e,t))if(e.value)s[e.name]=e.value;else{const r=t[e.variable];r&&(s[e.name]=r.value)}}),s}getNodes(e){this.config.nodes.forEach(t=>{const s=e[t.variable];let r;if(s&&this.passesCondition(t,e)){this.nodesMap.has(s.value)?r=this.nodesMap.get(s.value):(r={},this.nodesMap.set(s.value,r));const i=this.config.groups[t.group].properties||{},o=this.getProperties(t,e);Object.assign(r,i,o,{id:s.value,group:t.group})}})}getEdges(e){this.config.edges.forEach(t=>{const s=e[t.from],r=e[t.to];if("object"==typeof s&&"object"==typeof r){const i=s.value,o=r.value,n=[i,o].join("-");if(this.passesCondition(t,e)){const s={from:i,to:o,id:n,...this.getProperties(t,e)};this.edgeManager.addEdge(s)}}})}}return Object.setPrototypeOf(p,u),Object.setPrototypeOf(g,u),function(e,t){return e.verbose?new g(e):new p(e,t)}}));
